<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>회원가입/로그인</title>
    <style>
      .container {
        max-width: 400px;
        margin: 50px auto;
        padding: 20px;
      }
      .form-group {
        margin-bottom: 15px;
      }
      .form-group label {
        display: block;
        margin-bottom: 5px;
      }
      .form-group input {
        width: 100%;
        padding: 8px;
      }
      .btn {
        padding: 10px 15px;
        background-color: #007bff;
        color: white;
        border: none;
        cursor: pointer;
      }
      .error {
        color: red;
        display: none;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h2>회원가입</h2>
      <form id="signupForm">
        <div class="form-group">
          <label for="signupId">아이디</label>
          <div style="display: flex; gap: 10px">
            <input type="text" id="signupId" required />
            <button type="button" onclick="checkMemberId()" class="btn">
              중복확인
            </button>
          </div>
          <p id="idCheckMessage" style="margin-top: 5px; font-size: 14px"></p>
        </div>
        <div class="form-group">
          <label for="signupPwd">비밀번호</label>
          <input type="password" id="signupPwd" required />
        </div>
        <div class="form-group">
          <label for="signupName">이름</label>
          <input type="text" id="signupName" required />
        </div>
        <div class="form-group">
          <label for="signupEmail">이메일</label>
          <input type="email" id="signupEmail" required />
        </div>
        <div class="form-group">
          <label for="signupPhone">전화번호</label>
          <input type="tel" id="signupPhone" required />
        </div>
        <button type="submit" class="btn">회원가입</button>
        <p id="signupError" class="error"></p>
      </form>

      <h2>로그인</h2>
      <form id="signinForm">
        <div class="form-group">
          <label for="signinId">아이디</label>
          <input type="text" id="signinId" required />
        </div>
        <div class="form-group">
          <label for="signinPwd">비밀번호</label>
          <input type="password" id="signinPwd" required />
        </div>
        <button type="submit" class="btn">로그인</button>
        <p id="signinError" class="error"></p>
      </form>

      <div id="memberInfo" style="margin-top: 20px; display: none">
        <h2>회원 정보</h2>
        <p>이름: <span id="memberName"></span></p>
        <p>이메일: <span id="memberEmail"></span></p>
        <button onclick="getMemberInfo()" class="btn">정보 조회</button>
      </div>

      <button onclick="sendTokenAsync()" class="btn">비동기 토큰 전송</button>
    </div>

    <script>
      document
        .getElementById("signupForm")
        .addEventListener("submit", async (e) => {
          const messageEl = document.getElementById("idCheckMessage");
          if (!messageEl.textContent || messageEl.style.color === "red") {
            e.preventDefault();
            alert("아이디 중복 확인이 필요합니다.");
            return;
          }
          e.preventDefault();
          try {
            const response = await fetch("/sign/signup", {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
              },
              body: JSON.stringify({
                memberId: document.getElementById("signupId").value,
                pwd: document.getElementById("signupPwd").value,
                name: document.getElementById("signupName").value,
                email: document.getElementById("signupEmail").value,
                phone: document.getElementById("signupPhone").value,
                social: "N",
              }),
            });
            if (response.ok) {
              alert("회원가입이 완료되었습니다.");
              document.getElementById("signupForm").reset();
            } else {
              throw new Error("회원가입 실패");
            }
          } catch (error) {
            document.getElementById("signupError").style.display = "block";
            document.getElementById("signupError").textContent = error.message;
          }
        });

      document
        .getElementById("signinForm")
        .addEventListener("submit", async (e) => {
          e.preventDefault();
          try {
            const response = await fetch("/sign/signin", {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
              },
              body: JSON.stringify({
                memberId: document.getElementById("signinId").value,
                pwd: document.getElementById("signinPwd").value,
              }),
            });
            if (response.ok) {
              const token = await response.text();
              document.cookie = `accessToken=${token}; path=/; max-age=604800; secure`;
              alert("로그인이 완료되었습니다.");
              document.getElementById("signinForm").reset();
              document.getElementById("memberInfo").style.display = "block";
            } else {
              throw new Error("로그인 실패");
            }
          } catch (error) {
            document.getElementById("signinError").style.display = "block";
            document.getElementById("signinError").textContent = error.message;
          }
        });

      // 비동기 방식으로 토큰 전송
      async function sendTokenAsync() {
        try {
          const token = document.cookie
            .split("; ")
            .find((row) => row.startsWith("accessToken="))
            ?.split("=")[1];

          if (!token) {
            alert("토큰이 없습니다. 로그인이 필요합니다.");
            return;
          }

          const response = await fetch("/sign/cookie-test", {
            method: "POST",
            headers: {
              "Content-Type": "application/x-www-form-urlencoded",
            },
            body: `accessToken=${token}`,
          });

          if (response.ok) {
            const result = await response.text();
            alert("토큰 전송 성공\n" + result);
          } else {
            throw new Error("토큰 전송 실패");
          }
        } catch (error) {
          alert(error.message);
        }
      }

      // 아이디 중복 체크 함수
      async function checkMemberId() {
        const memberId = document.getElementById("signupId").value;
        const messageEl = document.getElementById("idCheckMessage");

        if (!memberId) {
          messageEl.style.color = "red";
          messageEl.textContent = "아이디를 입력해주세요.";
          return;
        }

        try {
          const response = await fetch(`/sign/check/${memberId}`);
          const data = await response.json();

          if (response.ok) {
            messageEl.style.color = data.duplicate ? "red" : "green";
            messageEl.textContent = data.message;
          } else {
            throw new Error(data.error || "중복 체크 실패");
          }
        } catch (error) {
          messageEl.style.color = "red";
          messageEl.textContent = error.message;
        }
      }
    </script>
  </body>
</html>
