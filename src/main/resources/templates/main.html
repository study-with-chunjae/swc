<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>회원가입/로그인</title>
    <style>
      .container1234 {
        max-width: 400px;
        margin: 50px auto;
        padding: 20px;
      }
      .form-group {
        margin-bottom: 15px;
      }
      .form-group label {
        display: block;
        margin-bottom: 5px;
      }
      .form-group input {
        width: 100%;
        padding: 8px;
      }
      .btn {
        padding: 10px 15px;
        background-color: #007bff;
        color: white;
        border: none;
        cursor: pointer;
      }
      .error {
        color: red;
        display: none;
      }
      .validation-message {
        margin-top: 5px;
        font-size: 14px;
        color: red;
        display: none;
      }
    </style>
  </head>
  <body>
    <div class="container1234">

  <!-- 강감찬 추가 로그인안되어있으면 에러 메시지 알럿 띄우기 -->
  <script th:inline="javascript">
    const error = [[${error}]];
    if(error){
      alert(error);
    }
  </script>
      
      <h2>회원가입</h2>
      <form id="signupForm">
        <div class="form-group">
          <label for="signupId">아이디</label>
          <div style="display: flex; gap: 10px">
            <input
              type="text"
              id="signupId"
              oninput="validateId(this)"
              required
            />
            <button type="button" onclick="checkMemberId()" class="btn">
              중복확인
            </button>
          </div>
          <p id="idCheckMessage" style="margin-top: 5px; font-size: 14px"></p>
          <p id="idValidMessage" class="validation-message">
            아이디는 영어 소문자와 숫자만 포함할 수 있습니다.
          </p>
        </div>
        <div class="form-group">
          <label for="signupPwd">비밀번호</label>
          <input
            type="password"
            id="signupPwd"
            oninput="validatePassword(this)"
            required
          />
          <p id="pwdValidMessage" class="validation-message">
            비밀번호는 영어, 숫자, 특수문자를 포함해야 하며, 10~20자여야 합니다.
          </p>
        </div>
        <div class="form-group">
          <label for="signupPwdConfirm">비밀번호 확인</label>
          <input type="password" id="signupPwdConfirm" required />
          <p id="pwdMatchMessage" class="validation-message">
            비밀번호가 일치하지 않습니다.
          </p>
        </div>
        <div class="form-group">
          <label for="signupName">이름</label>
          <input
            type="text"
            id="signupName"
            oninput="validateName(this)"
            required
          />
          <p id="nameValidMessage" class="validation-message">
            한국 이름만 가능합니다.
          </p>
        </div>
        <div class="form-group">
          <label for="signupEmail">이메일</label>
          <div style="display: flex; gap: 10px">
            <input
              type="email"
              id="signupEmail"
              oninput="validateEmail(this)"
              required
            />
            <button type="button" onclick="sendVerificationEmail()" class="btn">
              인증번호 전송
            </button>
          </div>
          <p id="emailValidMessage" class="validation-message">
            유효한 이메일 주소를 입력해주세요.
          </p>
          <div id="verificationSection" style="display: none; margin-top: 10px">
            <div style="display: flex; gap: 10px">
              <input
                type="text"
                id="verificationCode"
                placeholder="인증번호 6자리"
              />
              <span id="timer" style="line-height: 35px; color: #dc3545"></span>
            </div>
            <button
              type="button"
              onclick="verifyEmail()"
              class="btn"
              style="margin-top: 5px"
            >
              인증확인
            </button>
          </div>
          <p
            id="emailVerificationMessage"
            style="margin-top: 5px; font-size: 14px"
          ></p>
        </div>
        <div class="form-group">
          <label for="signupPhone">전화번호</label>
          <input
            type="tel"
            id="signupPhone"
            oninput="validatePhone(this)"
            required
          />
          <p id="phoneValidMessage" class="validation-message">
            전화번호는 11자리 숫자여야 합니다.
          </p>
        </div>
        <button type="submit" class="btn">회원가입</button>
        <p id="signupError" class="error"></p>
      </form>

      <h2>로그인</h2>
      <form id="signinForm">
        <div class="form-group">
          <label for="signinId">아이디</label>
          <input type="text" id="signinId" required />
        </div>
        <div class="form-group">
          <label for="signinPwd">비밀번호</label>
          <input type="password" id="signinPwd" required />
        </div>
        <button type="submit" class="btn">로그인</button>
        <p id="signinError" class="error"></p>
      </form>

      <div id="memberInfo" style="margin-top: 20px; display: none">
        <h2>회원 정보</h2>
        <p>이름: <span id="memberName"></span></p>
        <p>이메일: <span id="memberEmail"></span></p>
        <button onclick="getMemberInfo()" class="btn">정보 조회</button>
      </div>

      <button onclick="sendTokenAsync()" class="btn">비동기 토큰 전송</button>
    </div>

    <script>
      // 회원가입 스크립트 시작
      document
        .getElementById("signupForm")
        .addEventListener("submit", async (e) => {
          e.preventDefault();

          if (!isEmailVerified) {
            alert("이메일 인증이 필요합니다.");
            return;
          }

          const messageEl = document.getElementById("idCheckMessage");
          if (!messageEl.textContent || messageEl.style.color === "red") {
            alert("아이디 중복 확인이 필요합니다.");
            return;
          }

          const pwd = document.getElementById("signupPwd").value;
          const pwdConfirm = document.getElementById("signupPwdConfirm").value;

          if (pwd !== pwdConfirm) {
            alert("비밀번호가 일치하지 않습니다.");
            return;
          }

          try {
            const response = await fetch("/sign/signup", {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
              },
              body: JSON.stringify({
                memberId: document.getElementById("signupId").value,
                pwd: document.getElementById("signupPwd").value,
                name: document.getElementById("signupName").value,
                email: document.getElementById("signupEmail").value,
                phone: document.getElementById("signupPhone").value,
                social: "N",
              }),
            });
            if (response.ok) {
              alert("회원가입이 완료되었습니다.");
              document.getElementById("signupForm").reset();
              isEmailVerified = false;
              document.getElementById("verificationSection").style.display =
                "none";
              document.getElementById("emailVerificationMessage").textContent =
                "";
              document.getElementById("idCheckMessage").textContent = "";
              clearInterval(timerInterval);
            } else {
              throw new Error("회원가입 실패");
            }
          } catch (error) {
            document.getElementById("signupError").style.display = "block";
            document.getElementById("signupError").textContent = error.message;
          }
        });

      // 아이디 중복 체크 함수
      async function checkMemberId() {
        const memberId = document.getElementById("signupId").value;
        const messageEl = document.getElementById("idCheckMessage");

        if (!memberId) {
          messageEl.style.color = "red";
          messageEl.textContent = "아이디를 입력해주세요.";
          return;
        }

        try {
          const response = await fetch(`/sign/check/${memberId}`);
          const data = await response.json();

          if (response.ok) {
            messageEl.style.color = data.duplicate ? "red" : "green";
            messageEl.textContent = data.message;
          } else {
            throw new Error(data.error || "중복 체크 실패");
          }
        } catch (error) {
          messageEl.style.color = "red";
          messageEl.textContent = error.message;
        }
      }

      let timerInterval;
      let isEmailVerified = false;

      function validateEmail(input) {
        const messageEl = document.getElementById("emailValidMessage");
        const emailRegex = /^[a-zA-Z0-9._-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,6}$/;

        if (!emailRegex.test(input.value)) {
          messageEl.style.display = "block";
          return false;
        } else {
          messageEl.style.display = "none";
          return true;
        }
      }

      async function sendVerificationEmail() {
        const email = document.getElementById("signupEmail").value;
        const messageEl = document.getElementById("emailValidMessage");

        if (!validateEmail({ value: email })) {
          alert("유효한 이메일 주소를 입력해주세요.");
          return;
        }

        try {
          const response = await fetch("/sign/send-verification-email", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify({ email }),
          });

          if (response.ok) {
            document.getElementById("verificationSection").style.display =
              "block";
            startTimer(300);
            alert("인증번호가 전송되었습니다.");
          } else {
            throw new Error("인증번호 전송에 실패했습니다.");
          }
        } catch (error) {
          alert(error.message);
        }
      }

      function startTimer(duration) {
        clearInterval(timerInterval);
        const timerDisplay = document.getElementById("timer");
        let timer = duration;

        timerInterval = setInterval(() => {
          const minutes = Math.floor(timer / 60);
          const seconds = timer % 60;

          timerDisplay.textContent = `${minutes}:${seconds
            .toString()
            .padStart(2, "0")}`;

          if (--timer < 0) {
            clearInterval(timerInterval);
            timerDisplay.textContent = "시간 만료";
          }
        }, 1000);
      }

      async function verifyEmail() {
        const code = document.getElementById("verificationCode").value;
        const email = document.getElementById("signupEmail").value;

        try {
          const response = await fetch("/sign/verify-email", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify({
              email,
              code,
            }),
          });

          const messageEl = document.getElementById("emailVerificationMessage");
          if (response.ok) {
            messageEl.style.color = "green";
            messageEl.textContent = "이메일 인증이 완료되었습니다.";
            isEmailVerified = true;
            clearInterval(timerInterval);
          } else {
            messageEl.style.color = "red";
            messageEl.textContent = "인증번호가 일치하지 않습니다.";
            isEmailVerified = false;
          }
        } catch (error) {
          alert(error.message);
        }
      }

      document
        .getElementById("signupPwdConfirm")
        .addEventListener("input", function () {
          const pwd = document.getElementById("signupPwd").value;
          const pwdConfirm = this.value;
          const messageEl = document.getElementById("pwdMatchMessage");

          if (pwd !== pwdConfirm) {
            messageEl.style.display = "block";
          } else {
            messageEl.style.display = "none";
          }
        });

      function validateId(input) {
        const messageEl = document.getElementById("idValidMessage");
        if (!input.value.match(/^[a-z0-9]+$/)) {
          messageEl.style.display = "block";
        } else {
          messageEl.style.display = "none";
        }
      }

      function validatePassword(input) {
        const messageEl = document.getElementById("pwdValidMessage");
        if (
          !input.value.match(
            /^(?=.*[a-zA-Z])(?=.*\d)(?=.*[!@#$%^&*()_+\-=\[\]{};':\"\\|,.<>\/?]).{10,20}$/
          )
        ) {
          messageEl.style.display = "block";
        } else {
          messageEl.style.display = "none";
        }
      }

      function validateName(input) {
        const messageEl = document.getElementById("nameValidMessage");
        if (!input.value) {
          messageEl.style.display = "block";
        } else {
          messageEl.style.display = "none";
        }
      }

      function validatePhone(input) {
        const messageEl = document.getElementById("phoneValidMessage");
        if (!input.value.match(/^\d{11}$/)) {
          messageEl.style.display = "block";
        } else {
          messageEl.style.display = "none";
        }
      }

      // 회원가입 스크립트 끗

      // 로그인 스크립트 시작
      document
        .getElementById("signinForm")
        .addEventListener("submit", async (e) => {
          e.preventDefault();
          try {
            const response = await fetch("/sign/signin", {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
              },
              body: JSON.stringify({
                memberId: document.getElementById("signinId").value,
                pwd: document.getElementById("signinPwd").value,
              }),
            });

            if (response.ok) {
              const token = await response.text();
              document.cookie = `accessToken=${token}; path=/; max-age=604800; secure`;
              alert("로그인이 완료되었습니다.");
              document.getElementById("signinForm").reset();
              document.getElementById("memberInfo").style.display = "block";
            } else {
              const errorMessage = await response.text();
              alert(errorMessage);
              document.getElementById("signinError").style.display = "block";
              document.getElementById("signinError").textContent = errorMessage;
            }
          } catch (error) {
            alert(error.message);
            document.getElementById("signinError").style.display = "block";
            document.getElementById("signinError").textContent = error.message;
          }
        });

      // 비동기 방식으로 토큰 전송
      async function sendTokenAsync() {
        try {
          const token = document.cookie
            .split("; ")
            .find((row) => row.startsWith("accessToken="))
            ?.split("=")[1];

          if (!token) {
            alert("토큰이 없습니다. 로그인이 필요합니다.");
            return;
          }

          const response = await fetch("/sign/cookie-test", {
            method: "POST",
            headers: {
              "Content-Type": "application/x-www-form-urlencoded",
            },
            body: `accessToken=${token}`,
          });

          if (response.ok) {
            const result = await response.text();
            alert("토큰 전송 성공\n" + result);
          } else {
            throw new Error("토큰 전송 실패");
          }
        } catch (error) {
          alert(error.message);
        }
      }

      // 로그인 스크립트 끗
    </script>
  </body>
</html>
