<!DOCTYPE html>
<html
  lang="ko"
  xmlns:th="http://www.thymeleaf.org"
  xmlns:layout="http://www.ultrag.net.nz/thymeleaf/layout"
>
  <head>
    <meta charset="UTF-8" />
    <title>layout</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link th:href="@{/assets/css/main/header.css}" rel="stylesheet" />
    <link th:href="@{/assets/css/main/layout.css}" rel="stylesheet" />
    <style>
      body {
        margin: 0;
        padding: 0;
        background-color: #f3cd99;
      }

      /*친구검색추가(수진)*/
      /* 검색 결과 드롭다운 스타일 */
      .search-results {
        top: 65%;
        list-style: none;
        padding: 0;
        /*border: 1px solid #ccc;*/
        max-height: 200px;
        overflow-y: auto;
        position: relative;
        background-color: white;
        width: 100%;
        z-index: 1000;
      }
      .search-container {
        position: relative;
        width: 300px;
      }
      /* "더보기" 버튼 스타일 */
      .search-results .load-more-button {
        display: block;
        width: 100%;
        text-align: center;
        background-color: #f0f0f0;
        border: 1px solid #ccc;
        border-radius: 4px;
        cursor: pointer;
        padding: 10px;
        margin-top: 5px;
      }
      .search-results .load-more-button:hover {
        background-color: #e0e0e0;
      }

      /*친구검색추가(수진)*/
    </style>
  </head>

  <body>
    <div class="center">
      <div class="layoutHeader"></div>
    </div>
    <div class="ccenter">
      <header>
        <a href="/post/main"
          ><img
            th:src="@{/assets/public/logo.png}"
            alt="K-MOOC 로고"
            style="width: 150px"
        /></a>
        <nav>
          <ul class="tabs">
            <li
              th:class="${viewType == 'today' ? 'active' : ''}"
              th:onclick="|location.href='/post/main'|"
            >
              오늘의 학습
            </li>
            <li
              th:class="${viewType == 'my' ? 'active' : ''}"
              th:onclick="|location.href='/post/list'|"
            >
              나의학습
            </li>
            <li
              th:class="${viewType == 'share' ? 'active' : ''}"
              th:onclick="|location.href='/post/sharelist'|"
            >
              공유학습
            </li>
          </ul>
        </nav>
<!--        <div class="search-bar">-->
<!--          &lt;!&ndash;          친구검색연결(수진)&ndash;&gt;-->
          <div class="search-bar search-container" style="position: relative; width: 422px;">
          <input type="text" id="keyword" name="keyword" placeholder="Search..."/>
            <ul class="search-results" id="search-results" style="position: absolute; width: 410px;">
            <!-- 검색 결과가 동적으로 추가됨 -->
             </ul>
          <button type="button" id="load-more-button" class="search-results load-more-button">더보기</button>
          <!--          친구검색연결(수진)-->
            <button>
            <a href="/main/main"
              ><img
                th:src="@{/assets/public/pen.png}"
                alt="serach 로고"
                style="width: 20px"
            /></a>
          </button>
        </div>

        <div class="user-info">
          <a href="/myPage/info" class="user-name"></a>
          <ul class="dropdown2">
            <li><a href="/myPage/info">내 정보</a></li>
            <li><a href="/myPage/followList">친구 요청</a></li>
            <li><a href="/myPage/friend">친구 목록</a></li>
            <li><a href="/myPage/message">쪽지 목록</a></li>
          </ul>
          <button class="alertIcon"></button>
          <div class="alertCount">9</div>
          <button class="login-btn" onclick="location.href='/sign/logout'">
            <img
              src="/assets/public/exitDoor.png"
              alt="로그아웃"
              width="40px"
            />
            <span class="tooltip">로그아웃</span>
          </button>
        </div>
      </header>
    </div>

    <div class="center">
      <div class="contentArea">
        <div layout:fragment="mainContent" class="mainContent"></div>
      </div>
    </div>

    <th:block layout:fragment="script">
      <script
        src="https://cdn.jsdelivr.net/npm/jwt-decode/build/jwt-decode.min.js"
      ></script>
      <script>
        let userName = "";
        function getCookie(name) {
          const value = `; ${document.cookie}`;
          const parts = value.split(`; ${name}=`);
          if (parts.length === 2) return parts.pop().split(";").shift();
        }

        const accessToken = getCookie("accessToken");

        if (accessToken) {
          const decodedToken = jwt_decode(accessToken);
          userName = decodedToken.name;

          document.querySelector(".user-name").textContent = userName;
        } else {
          console.error("Access token is not available.");
        }

        console.log(userName);

        // 친구검색추가(수진)
        const keywordInput = document.getElementById('keyword');
        const searchResultsList = document.getElementById('search-results');
        const loadMoreButton = document.getElementById('load-more-button');
        let debounceTimeout = null;
        let currentPage = 0;
        let currentKeyword = '';

        // 초기 "더보기" 버튼 숨기기
        loadMoreButton.style.display = 'none';

        keywordInput.addEventListener('input', function() {
          const keyword = this.value.trim();
          currentKeyword = keyword;
          currentPage = 0; // 새로운 검색 시 페이지 초기화

          // 디바운싱: 300ms 동안 입력이 없으면 검색 요청
          if (debounceTimeout) {
            clearTimeout(debounceTimeout);
          }

          debounceTimeout = setTimeout(() => {
            if (keyword.length === 0) {
              searchResultsList.innerHTML = '';
              loadMoreButton.style.display = 'none';
              return;
            }

            // 검색 초기화
            searchResultsList.innerHTML = '';
            fetchFriends(keyword, currentPage);
          }, 300);
        });

        function fetchFriends(keyword, page) {
          fetch(`/friend/search?keyword=${encodeURIComponent(keyword)}&limit=5&page=${page}`)
                  .then(response => response.json())
                  .then(data => {
                    displaySearchResults(data);
                    // "더보기" 버튼 표시 여부 결정
                    if (data.length === 5) { // limit=5
                      loadMoreButton.style.display = 'block';
                    } else {
                      loadMoreButton.style.display = 'none';
                    }
                  })
                  .catch(error => {
                    console.error('Error:', error);
                  });
        }

        function displaySearchResults(members) {
          if (currentPage === 0) {
            searchResultsList.innerHTML = ''; // 검색 초기화
          }

          if (members.length === 0 && currentPage === 0) {
            const li = document.createElement('li');
            li.textContent = '검색 결과가 없습니다.';
            searchResultsList.appendChild(li);
            loadMoreButton.style.display = 'none'; // 결과가 없으므로 "더보기" 숨김
            return;
          }

          // 멤버 추가
          members.forEach(member => {
            const li = document.createElement('li');
            const span = document.createElement('span');
            span.textContent = `${member.memberId} (${member.name})`;

            const requestButton = document.createElement('button');
            requestButton.textContent = '친구 신청';
            requestButton.className = 'button button-request';
            requestButton.onclick = () => sendFriendRequest(member.memberId);

            li.appendChild(span);
            li.appendChild(requestButton);
            searchResultsList.appendChild(li);
          });

          // "더보기" 버튼 재배치
          if (members.length === 5) { // limit=5 기준
            loadMoreButton.style.display = 'block';
            searchResultsList.appendChild(loadMoreButton);
          } else {
            loadMoreButton.style.display = 'none';
          }
        }

        // "더보기" 버튼 클릭 시 다음 페이지 로드
        loadMoreButton.addEventListener('click', function() {
          currentPage += 1;
          fetchFriends(currentKeyword, currentPage);
        });

        function sendFriendRequest(receiverId) {
          fetch('/friend/request', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json'
            },
            body: JSON.stringify({ receiver: receiverId })
          })
                  .then(response => {
                    if (!response.ok) {
                      return response.text().then(text => { throw new Error(text) });
                    }
                    return response.text();
                  })
                  .then(message => {
                    alert(message);
                  })
                  .catch(error => {
                    console.error('Error:', error);
                    alert(error.message || '친구 요청에 실패했습니다.');
                  });
        }
        // 친구검색추가(수진)

      </script>
    </th:block>
  </body>
</html>
