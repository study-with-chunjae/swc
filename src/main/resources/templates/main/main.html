<!DOCTYPE html>
<html
  lang="ko"
  xmlns:th="http://www.thymeleaf.org"
  xmlns:layout="https://www.ultraq.net.nz/thymeleaf/layout"
  layout:decorate="~{main/layout.html}"
>
  <head>
    <link th:href="@{/assets/css/main/main.css}" rel="stylesheet" />
  </head>

  <div layout:fragment="mainContent" class="fontQnsvlf">
    <div class="flex">
      <section class="content1">
        <div>
          <h3 style="text-align: center; margin-top: 15px">í”„ë¡œí•„</h3>
          <aside class="shared-learning">
            <div class="thumbnail-group center">
              <img
                th:src="${profileImage.getPath() != null ? profileImage.getPath() : '/assets/public/human.png'}"
                alt="Thumbnail"
              />
            </div>
            <button class="profileImgEdit" onclick="openProfileModal()">
              Edit
            </button>
            <div
              class="likes"
              th:text="${memberDTO.name + 'ë‹˜'}"
              style="text-align: center; margin-top: 10px"
            ></div>
            <div>
              <button
                class="button"
                th:data-member-id="${memberDTO.memberId}"
                onclick="handleFriendRequest(this)"
              >
                <img
                  th:src="@{/assets/public/followIcon.png}"
                  alt="friendPlus"
                  width="15px"
                />
                ì¹œêµ¬ ì¶”ê°€
              </button>
              <button
                class="button"
                th:data-member-id="${memberDTO.memberId}"
                onclick="sendMessage(this)"
              >
                âœ‰ï¸ ìª½ì§€ ë³´ë‚´ê¸°
              </button>
              <div>
                <script>
                  function sendMessage(button) {
                    var receiverId = button.getAttribute("data-member-id");
                    if (!receiverId) {
                      alert("ë°›ëŠ” ì‚¬ëŒì˜ IDê°€ ì—†ìŠµë‹ˆë‹¤.");
                      return;
                    }
                    window.location.href =
                      "/message/regist?receiverId=" + receiverId;
                  }
                </script>
              </div>
              <button class="button" id="registBtn">ğŸ“ í•™ìŠµ ë“±ë¡</button>
              <div>
                <script>
                  const registBtn = document.getElementById("registBtn");
                  registBtn.addEventListener("click", () => {
                    location.href = "/post/register";
                  });
                </script>
              </div>
            </div>
            <div class="studyDream center">
              <div>
                <p style="text-align: center">í•™ìŠµ ëª©í‘œ</p>
                <div
                  class="center studyDreamContent"
                  th:text="${memberDTO.myInfo}"
                ></div>
              </div>
            </div>
          </aside>
        </div>
      </section>

      <section class="content2">
        <h2>ì˜¤ëŠ˜ì˜ í•™ìŠµ</h2>
        <section class="content3" style="margin-top: 20px">
          <div class="weekday-container">
            <button class="arrow up">â–²</button>
            <ul id="weekday-list" class="weekday-list">
              <!-- Days will be dynamically injected here -->
            </ul>
            <button class="arrow down">â–¼</button>
            <p id="today" style="font-size: 16px; text-align: center">
              <b th:text="${month + 'ì›” ' + date + 'ì¼'}"></b><br>
              <span th:text="${'(' + month + 'ì›”,' + week +'ì£¼)'}"></span>
            </p>
          </div>
          <div class="slider-container">
            <div class="slider-wrapper">
              <div class="slider" id="slider">
                <article
                  class="learning-card"
                  th:if="${!postMainDTOList.isEmpty()}"
                  th:each="post, status:${postMainDTOList}"
                >
                  <div class="thumbnail">
                    <img
                      th:src="${post.image == null ? '/upload/images/default_image.jpg' : post.image}"
                      alt="Thumbnail"
                    />
                    <div class="category">
                      <div class="tag-container">
                        <strong>í•´ì‹œíƒœê·¸</strong>:
                        <th:block th:each="tag,status:${post.hashtag}">
                          <div
                            class="tag-div"
                            th:text="${tag}"
                            th:data-tag="${tag}"
                            th:onclick="'search(this);'"
                          ></div>
                        </th:block>
                      </div>
                    </div>
                    <div class="thumbUps">
                      â¤ï¸ ì¢‹ì•„ìš” <span th:text="${post.thumbUps}"></span>
                    </div>
                  </div>
                  <div class="info">
                    <h3 class="title" th:text="${post.title}"></h3>
                    <p class="description" th:text="${post.content}"></p>
                    <div class="shared-by">
                      <th:block th:each="share, status:${post.shares}">
                        <div th:text="${share}"></div>
                      </th:block>
                    </div>
                  </div>
                </article>
                <article
                  class="learning-card"
                  th:if="${postMainDTOList.isEmpty()}"
                >
                  <div class="info">
                    <h3
                      class="title"
                      th:text="'ë“±ë¡ëœ ì˜¤ëŠ˜ì˜í•™ìŠµì´ ì—†ìŠµë‹ˆë‹¤.'"
                    ></h3>
                  </div>
                </article>
                <!-- ì¶”ê°€ì ìœ¼ë¡œ ë” ë§ì€ <article> ìš”ì†Œë¥¼ ë“±ë¡ -->
              </div>
            </div>
            <div class="slider-indicators">
              <!-- Dots will be dynamically added here -->
            </div>
          </div>
        </section>
      </section>
      <div>
        <script th:inline="javascript">
          let baseDate = new Date([[${createdAt}]]);
          function search(element){
            const tag = element.getAttribute("data-tag");
            location.href="/post/sharelist?type=others&searchField=hashtag&searchValue="+tag.replace('#','');
          }
        </script>
        <script
          th:src="@{/assets/js/main.js}"
          layout:fragment="mainscript"
          th:inline="javascript"
        ></script>
      </div>
      <!-- í”„ë¡œí•„ ì‚¬ì§„ ë³€ê²½ ëª¨ë‹¬ -->
      <div id="profileModal">
        <div class="modal-content">
          <h3>í”„ë¡œí•„ ì‚¬ì§„ ë³€ê²½</h3>
          <input
            type="file"
            id="profileFile"
            accept="image/*"
            onchange="previewImage(event)"
          />
          <img id="preview" />
          <button onclick="saveProfileImage()">ì €ì¥</button>
          <button onclick="closeProfileModal()">ì·¨ì†Œ</button>
        </div>
      </div>

      <script>
        function openProfileModal() {
          document.getElementById("profileModal").style.display = "flex";
        }

        function closeProfileModal() {
          document.getElementById("profileModal").style.display = "none";
        }

        function previewImage(event) {
          const preview = document.getElementById("preview");
          const file = event.target.files[0];
          const reader = new FileReader();

          reader.onload = function (e) {
            preview.src = e.target.result;
            preview.style.display = "block";
          };

          if (file) {
            reader.readAsDataURL(file);
          }
        }

        function saveProfileImage() {
          const fileInput = document.getElementById("profileFile");
          const formData = new FormData();
          formData.append("file", fileInput.files[0]);

          fetch("/myPage/update-profile-image", {
            method: "POST",
            body: formData,
          })
            .then((response) => {
              if (!response.ok) {
                throw new Error("ì„œë²„ ì‘ë‹µ ì˜¤ë¥˜");
              }
              return response.json();
            })
            .then((data) => {
              if (data.success) {
                alert("í”„ë¡œí•„ ì‚¬ì§„ì´ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤.");
                closeProfileModal();
                location.reload();
              } else {
                alert("í”„ë¡œí•„ ì‚¬ì§„ ë³€ê²½ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
              }
            })
            .catch((error) => {
              console.error("Error:", error);
              alert("ë³€ê²½ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
            });
        }
      </script>
    </div>
  </div>
</html>
