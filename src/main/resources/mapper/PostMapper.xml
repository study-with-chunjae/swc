<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="net.fullstack7.swc.mapper.PostMapper">
    <select id="totalCount">
        SELECT COUNT(DISTINCT postId)
        FROM post
        <where>
            <if test="searchField != null and searchValue != null">
                <choose>
                    <when test="searchField == 'title'">
                        title LIKE CONCAT('%', #{searchValue}, '%')
                    </when>
                    <when test="searchField == 'content'">
                        content LIKE CONCAT('%', #{searchValue}, '%')
                    </when>
                    <when test="searchField == 'topics'">
                        topics = #{searchValue}
                    </when>
                    <when test="searchField == 'hashtag'">
                        hashtag LIKE CONCAT('%', #{searchValue}, '%')
                    </when>
                </choose>
            </if>
            <if test="searchDateBegin != null">
                AND createdAt &gt;= #{searchDateBegin}
            </if>
            <if test="searchDateEnd != null">
                AND createdAt &lt;= #{searchDateEnd}
            </if>
            AND userId = #{memberId}
        </where>
    </select>
    <select id="postList">
        SELECT p.*, COUNT(t.postId) as thumbUpCount
        FROM post p
        LEFT JOIN thumbUp t ON p.postId = t.postId
        <where>
            <if test="searchField != null and searchValue != null">
                <choose>
                    <when test="searchField == 'title'">
                        p.title LIKE CONCAT('%', #{searchValue}, '%')
                    </when>
                    <when test="searchField == 'content'">
                        p.content LIKE CONCAT('%', #{searchValue}, '%')
                    </when>
                    <when test="searchField == 'topics'">
                        p.topics = #{searchValue}
                    </when>
                    <when test="searchField == 'hashtag'">
                        p.hashtag LIKE CONCAT('%', #{searchValue}, '%')
                    </when>
                </choose>
            </if>
            <if test="searchDateBegin != null">
                AND createdAt &gt;= #{searchDateBegin}
            </if>
            <if test="searchDateEnd != null">
                AND createdAt &lt;= #{searchDateEnd}
            </if>
            AND p.userId = #{memberId}
        </where>
        GROUP BY p.postId
        <choose>
            <when test="sortType == 'thumbUps'">
                ORDER BY thumbUpCount DESC, p.createdAt DESC
            </when>
            <otherwise>
                ORDER BY p.createdAt DESC
            </otherwise>
        </choose>
        LIMIT #{offset}, #{pageSize}
    </select>
</mapper>